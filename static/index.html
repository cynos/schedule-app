<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>schedult management</title>
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="./assets/css/dataTables.min.css" rel="stylesheet">

    <script src="./assets/js/jquery-3.3.1.min.js" charset="utf-8"></script>
    <script src="./assets/js/bootstrap.bundle.min.js" charset="utf-8"></script>
    <script src="./assets/js/dataTables.min.js" charset="utf-8"></script>
    <script src="./assets/js/js-cookies.js" charset="utf-8"></script>

  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col">
          <div class="card my-5">
            <div class="card-header">
              Jadwal Kegiatan
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <a href="#" class="btn btn-success" data-mode="tambah" data-toggle="modal", data-target="#modal">Tambah Jadwal</a>
                  <a href="#" class="btn btn-danger" onclick="logout()">Logout</a>
                </div>
                <div class="w-100 my-2"></div>
                <div class="col">
                  <table id="table" class="display table table-striped table" style="width:100%">
                    <thead>
                        <tr>
                          <th>No</th>
                          <th>Kegiatan</th>
                          <th>Tanggal</th>
                          <th>Jam</th>
                          <th>Opsi</th>
                        </tr>
                    </thead>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal hapus -->
      <div class="modal fade" id="modal-hapus" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalLabel">Peringatan</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Yakin hapus jadwal ini ?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
              <form id="form-modal">
                <button type="submit" class="btn btn-primary">Ya</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalLabel"></h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form id="form-modal">
              <input name="id" hidden type="text" id="f-id">
              <div class="modal-body">
                <div class="form-group">
                  <label>Nama Kegiatan</label>
                  <input name="kegiatan" class="form-control" type="text" placeholder="Default input" id="f-kegiatan" required>
                </div>
                <div class="form-group">
                  <div class="row">
                    <div class="col">
                      <label>Tanggal</label>
                      <input name="tanggal" class="form-control" type="date" placeholder="Default input" id="f-tanggal" required>
                    </div>
                    <div class="col">
                      <label>Waktu</label>
                      <input name="waktu" class="form-control" type="time" placeholder="Default input" id="f-waktu" required>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-primary">Simpan</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </div>
  </body>
  <script type="text/javascript">
    var base_url = "http://localhost:8080";

    (function(){
      if (Cookies.get("login") == null) {
        window.location.href = base_url+"/static/login.html"
      }
    })();

    function logout(){
      Cookies.remove('login')
      $.post({
        url: base_url+"/logout",
        success: function(res){
          if (res) {
            Cookies.remove('token')
            location.reload(true)
          }
        }
      })
    }

    $(document).ready(function() {
      var table = $('#table').DataTable( {
        "processing": true,
        "ajax": {
          "type": "POST",
          "url": base_url+"/action-schedule",
          "data": {method:"read"},
          "dataSrc": function (j) {
            var data = new Array(),
                ctr  = 1;
            for (var i = 0; i < j.data.length; i++) {
              split = j.data[i].Jam.split("|")
              data.push({
                "No" : ctr++,
                "Kegiatan" : j.data[i].Kegiatan,
                "Tanggal" : split[0],
                "Waktu" : split[1],
                "Opsi" : `
                  <a href="#" class="btn btn-secondary btn-sm" data-mode="edit" data-toggle="modal" data-target="#modal" data-id="${j.data[i].ID}">Edit</a>
                  <a href="#" class="btn btn-secondary btn-sm" data-mode="hapus" data-toggle="modal" data-target="#modal-hapus" data-id="${j.data[i].ID}">Delete</a>
                `,
              })
            }
            return data
          }
        },
        "columns" : [
          { "data": "No" },
          { "data": "Kegiatan" },
          { "data": "Tanggal" },
          { "data": "Waktu" },
          { "data": "Opsi" },
        ]
      });

      var rowData
      $('#table tbody').on('click', 'a', function () {
        rowData = table.row( $(this).parents('tr') ).data();
      });

      $('#modal-hapus').on('show.bs.modal', function(event){
        var btn = $(event.relatedTarget)
        var id  = btn.data('id')
        var modal = $(this)
        var form  = modal.find('#form-modal')

        form.on('submit', function(event){
          event.preventDefault()
          $.ajax({
            "url": base_url+'/action-schedule',
            'type': 'POST',
            'data': {method:'delete', id:id},
            'dataType': 'json',
            success: function(res){
              modal.modal('hide')
              table.ajax.reload()
            },
            error: function(res){
              console.log(res);
            }
          })
        })
      })

      $('#modal').on('show.bs.modal', function(event){
        var btn   = $(event.relatedTarget)
        var mode  = btn.data('mode')
        var modal = $(this)

        switch (mode) {
          case 'edit':
            modal.find('#modalLabel').html('Edit Jadwal')
            modal.find('#f-id').val(btn.data('id'))
            modal.find('#f-kegiatan').val(rowData.Kegiatan)
            modal.find('#f-waktu').val(rowData.Waktu)
            modal.find('#f-tanggal').val(rowData.Tanggal)
            submitModal('update')
            break;
          case 'tambah':
            modal.find('#form-modal')[0].reset()
            submitModal('create')
            break;
        }
      })

      function submitModal(method) {
        $('#modal').on('submit', '#form-modal', function(event){
          event.preventDefault()

          var modal = $(this)
          var data = new Object()

          data.Kegiatan = modal.find('#f-kegiatan').val()
          data.Jam      = modal.find('#f-tanggal').val()+'|'+modal.find('#f-waktu').val()

          switch (method) {
            case 'update':
              data.method   = 'update'
              data.id       = modal.find('#f-id').val()
              break;
            case 'create':
              data.method   = 'create'
              break;
          }

          $.ajax({
            "url": base_url+'/action-schedule',
            'type': 'POST',
            'data': data,
            'dataType': 'json',
            success: function(res){
              $('#modal').modal('hide')
              table.ajax.reload()
            },
            error: function(res){
              console.log(res);
            }
          })
        })
      }

    });
  </script>
</html>
